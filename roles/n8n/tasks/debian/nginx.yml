---
- name: Install nginx
  ansible.builtin.apt:
    name: "{{ nginx_pkg }}"
    state: present
    update_cache: yes

- name: Enable and start nginx
  ansible.builtin.service:
    name: nginx
    state: started
    enabled: yes

- name: Ensure vhosts dir exists
  ansible.builtin.file:
    path: /etc/nginx/vhosts
    state: directory
    mode: "0755"

- name: Ensure nginx includes /etc/nginx/vhosts/*.conf
  ansible.builtin.lineinfile:
    path: /etc/nginx/nginx.conf
    insertafter: 'http\s*\{'
    line: '    include /etc/nginx/vhosts/*.conf;'
    state: present
  notify: reload nginx

- name: Deploy nginx vhost for n8n
  ansible.builtin.template:
    src: nginx_n8n.conf.j2
    dest: "/etc/nginx/vhosts/{{ vhost }}.conf"
    mode: "0644"
  notify: reload nginx

- name: Create ACME webroot for this vhost
  ansible.builtin.file:
    path: "/var/www/{{ vhost }}/.well-known/acme-challenge"
    state: directory
    owner: root
    group: root
    mode: "0755"
  become: true

- name: Validate nginx config
  ansible.builtin.command: nginx -t
  changed_when: false
