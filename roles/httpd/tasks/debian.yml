---
- name: Enable http(s) on ufw
  community.general.ufw:
    state: enabled
    rule: allow
    port: "{{ item }}"
    proto: tcp
  loop:
    - http
    - https

- name: Check if nginx is already installed
  ansible.builtin.stat:
    path: /etc/nginx
  register: _httpd_nginx_check

- name: Install apache2
  ansible.builtin.apt:
    name: apache2
    state: present
    update_cache: true

- name: Change Apache listening port to 8080 if NGINX is present
  ansible.builtin.lineinfile:
    path: /etc/apache2/ports.conf
    regexp: '^Listen '
    line: 'Listen 8080'
  when: _httpd_nginx_check.stat.exists
  notify: Restart apache2

- name: Add vhost config
  ansible.builtin.template:
    src: vhost.j2
    dest: "/etc/apache2/sites-available/{{ _vhost_name }}.conf"
    mode: "0644"
  notify: Restart apache2

- name: Ensure Apache vhost uses correct address and port
  ansible.builtin.lineinfile:
    path: "/etc/apache2/sites-available/{{ _vhost_name }}.conf"
    regexp: "^<VirtualHost"
    line: >-
      <VirtualHost {% if _httpd_nginx_check.stat.exists %}127.0.0.1:8080{% else %}*:80{% endif %}>
  notify: Restart apache2

- name: Create vhost symlink
  ansible.builtin.file:
    state: link
    path: "/etc/apache2/sites-enabled/{{ _vhost_name }}.conf"
    src: "/etc/apache2/sites-available/{{ _vhost_name }}.conf"
  notify: Restart apache2

- name: Create /var/www vhost subdir
  ansible.builtin.file:
    state: directory
    path: "/var/www/{{ _vhost_name }}/"
    owner: www-data
    group: www-data
    mode: "0755"
  notify: Restart apache2
